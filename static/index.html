<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>要約アプリ</title>
    <!-- Vue.jsをCDNから読み込み -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap 5.3+ JSをCDNから読み込み (ダークモード対応) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap 5.3+ CSSをCDNから読み込み (ダークモード対応) -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Bootstrap IconsをCDNから読み込み -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

    <div id="app" class="container">
        <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
            <h2 class="mb-0">要約アプリ</h2>
            <div>
                <button @click="openHistoryModal" class="btn btn-outline-secondary me-2">履歴</button>
                <button @click="toggleTheme" class="btn btn-outline-secondary" style="width: 42px; height: 42px;">
                    <i :class="theme === 'light' ? 'bi-moon-stars-fill' : 'bi-sun-fill'"></i>
                </button>
            </div>
        </div>

        <!-- 1. 設定カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>1. オプション設定</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <label class="form-label fw-bold">出力形式</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="formatParagraph" value="paragraph" v-model="summaryFormat">
                            <label class="form-check-label" for="formatParagraph">文章で要約</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="formatBullets" value="bullets" v-model="summaryFormat">
                            <label class="form-check-label" for="formatBullets">箇条書きで要約</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">要約の長さ</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="lengthShort" value="short" v-model="summaryLength">
                            <label class="form-check-label" for="lengthShort">短く</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="lengthMedium" value="medium" v-model="summaryLength">
                            <label class="form-check-label" for="lengthMedium">普通</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="lengthDetailed" value="detailed" v-model="summaryLength">
                            <label class="form-check-label" for="lengthDetailed">詳しく</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 入力カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-keyboard me-2"></i>2. 内容の入力</h5>
            </div>
            <div class="card-body pb-0">
                <ul class="nav nav-tabs" id="inputTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-panel" type="button" role="tab" aria-controls="text-panel" aria-selected="true" @click="activeTab = 'text'"><i class="bi bi-textarea-t me-1"></i>テキスト入力</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button" role="tab" aria-controls="url-panel" aria-selected="false" @click="activeTab = 'url'"><i class="bi bi-link-45deg me-1"></i>URL入力</button>
                    </li>
                </ul>
                <div class="tab-content" id="inputTabContent">
                    <div class="tab-pane fade show active" id="text-panel" role="tabpanel" aria-labelledby="text-tab">
                        <textarea id="inputText" class="form-control mt-3" rows="8" v-model="inputText" placeholder="ここにニュース記事などを貼り付け..."></textarea>
                    </div>
                    <div class="tab-pane fade" id="url-panel" role="tabpanel" aria-labelledby="url-tab">
                        <input type="url" id="inputUrl" class="form-control mt-3" v-model="inputUrl" placeholder="要約したい記事のURLを入力してください (例: https://example.com/article)">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 mb-4">
            <button @click="execute" class="btn btn-primary w-100" :disabled="isLoading">
                <span v-if="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                {{ isLoading ? '処理中...' : '要約を実行' }}
            </button>
        </div>

        <!-- 3. 結果カード -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>3. 結果</h5>
                <div>
                    <span v-if="resultCharCount > 0" class="text-muted me-3 small">文字数: {{ resultCharCount }}</span>
                    <button class="btn btn-sm btn-secondary" @click="copyResult" :disabled="!resultText || resultText.startsWith('エラー:') || resultText.startsWith('ここに')"><i class="bi bi-clipboard me-1"></i>コピー</button>
                </div>
            </div>
            <div class="card-body">
                <div class="result-area p-3 rounded" :class="{ 'alert alert-info': resultText && !resultText.startsWith('エラー:'), 'alert alert-danger': resultText.startsWith('エラー:') }">
                    <pre style="white-space: pre-wrap; margin-bottom: 0;">{{ resultText }}</pre>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">通知</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" v-text="toastMessage"></div>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="historyModalLabel">要約履歴</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="history.length === 0" class="text-center text-muted">
                            履歴はありません。
                        </div>
                        <ul v-else class="list-group">
                            <li v-for="item in history" :key="item.id" class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="me-3" style="flex-grow: 1; min-width: 0;">
                                    <small class="text-muted">{{ new Date(item.id).toLocaleString() }}</small>
                                    <p class="mb-1 text-truncate"><strong>入力:</strong> {{ item.input }}</p>
                                    <p class="mb-0 text-truncate text-muted"><strong>結果:</strong> {{ item.output }}</p>
                                </div>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" @click="applyHistory(item)">復元</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteHistoryItem(item.id)">削除</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" @click="clearAllHistory" :disabled="history.length === 0">全履歴を削除</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    inputText: '',
                    resultText: 'ここに出力形式を選んで、文章を貼り付けて実行してください。',
                    summaryFormat: 'paragraph', // 'paragraph' or 'bullets'
                    summaryLength: 'medium', // 'short', 'medium', or 'detailed'
                    inputUrl: '', // URL入力用,
                    activeTab: 'text', // 現在アクティブなタブ ('text' or 'url')
                    isLoading: false, // 処理中フラグ
                    theme: 'light', // 'light' or 'dark'
                    toastInstance: null,
                    toastMessage: '',
                    history: [], // 履歴を格納する配列
                    historyModalInstance: null,
                    maxHistorySize: 20 // 履歴の最大保存件数
                };
            },
            watch: {
                theme(newTheme) {
                    document.documentElement.setAttribute('data-bs-theme', newTheme);
                }
            },
            computed: {
                resultCharCount() {
                    if (this.resultText && !this.resultText.startsWith('エラー:') && !this.resultText.startsWith('ここに') && !this.resultText.startsWith('処理中...')) {
                        return this.resultText.length;
                    }
                    return 0;
                }
            },
            created() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    this.theme = savedTheme;
                } else {
                    // システムのテーマ設定を検出
                    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    this.theme = prefersDark ? 'dark' : 'light';
                }
                // This is redundant due to the watcher, but ensures the theme is set on initial load
                // It's good practice to have it here.
                document.documentElement.setAttribute('data-bs-theme', this.theme);
            },
            mounted() {
                const toastEl = document.getElementById('appToast');
                this.toastInstance = new bootstrap.Toast(toastEl);

                const historyModalEl = document.getElementById('historyModal');
                this.historyModalInstance = new bootstrap.Modal(historyModalEl);

                const savedHistory = localStorage.getItem('summaryHistory');
                if (savedHistory) this.history = JSON.parse(savedHistory);
            },
            methods: {
                async execute() {
                    if (this.isLoading) {
                        return; // 処理中の場合は多重実行を防ぐ
                    }

                    // 入力チェックをアクティブなタブに応じて変更
                    if (this.activeTab === 'text' && !this.inputText.trim()) {
                        this.resultText = 'エラー: 要約するテキストを入力してください。';
                        return;
                    } else if (this.activeTab === 'url') {
                        const url = this.inputUrl.trim();
                        if (!url) {
                            this.resultText = 'エラー: 要約するURLを入力してください。';
                            return;
                        }
                        // URL形式の簡易チェック (http/httpsから始まるか)
                        if (!url.startsWith('http://') && !url.startsWith('https://')) {
                            this.resultText = 'エラー: 有効なURL形式で入力してください。(http:// または https:// から始めてください)';
                            return;
                        }
                    }

                    this.isLoading = true;
                    this.resultText = '処理中...';

                    // Build the context based on the selected format and length
                    let context = 'あなたは優秀な編集者です。以下の文章を、';

                    // Add length instruction
                    if (this.summaryLength === 'short') {
                        context += 'ごく短く';
                    } else if (this.summaryLength === 'medium') {
                        context += '簡潔に';
                    } else if (this.summaryLength === 'detailed') {
                        context += '詳細に';
                    }

                    // Add format instruction
                    if (this.summaryFormat === 'paragraph') {
                        context += '要約してください。要約文のみを出力し、前後の説明文は一切含めないでください。';
                    } else { // 'bullets'
                        context += '箇条書きでまとめてください。箇条書きのリストのみを出力し、前後の説明文は一切含めないでください。';
                    }

                    try {
                        let payload = { context: context };
                        if (this.activeTab === 'text') {
                            payload.text = this.inputText;
                        } else {
                            payload.url = this.inputUrl;
                            // URL入力時は、テキストエリアをクリアしておく（見た目のため）
                            this.inputText = '';
                            this.inputUrl = ''; // 実行後URL入力欄をクリア
                        };

                        const response = await fetch('/send_api', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json();
                        if (response.ok) {
                            this.resultText = data.processed_text;
                            // 成功時に履歴を保存
                            this.saveToHistory({
                                type: this.activeTab,
                                input: this.activeTab === 'text' ? this.inputText : payload.url, // 保存するURLはクリア前のもの
                                output: data.processed_text,
                                settings: {
                                    format: this.summaryFormat,
                                    length: this.summaryLength
                                }
                            });
                        } else {
                            this.resultText = `エラー: ${data.error || '不明なエラーが発生しました。'}`;
                        }
                    } catch (error) {
                        this.resultText = `エラー: ${error.message}`;
                    } finally {
                        this.isLoading = false; // 処理が完了したら必ずボタンを有効化する
                    }
                },
                async copyResult() {
                    // 初期テキストやエラーメッセージはコピーしない
                    if (!this.resultText || this.resultText.startsWith('エラー:') || this.resultText.startsWith('ここに')) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(this.resultText);
                        this.showToast('クリップボードにコピーしました');
                    } catch (err) {
                        console.error('クリップボードへのコピーに失敗しました: ', err);
                        this.showToast('コピーに失敗しました');
                    }
                },
                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('theme', this.theme);
                },
                showToast(message) {
                    this.toastMessage = message;
                    this.toastInstance.show();
                },
                openHistoryModal() {
                    this.historyModalInstance.show();
                },
                saveToHistory(item) {
                    const newHistoryItem = {
                        id: Date.now(), // ユニークなIDとしてタイムスタンプを使用
                        ...item
                    };
                    // 新しい項目を先頭に追加
                    this.history.unshift(newHistoryItem);
                    // 履歴が最大件数を超えたら古いものから削除
                    if (this.history.length > this.maxHistorySize) {
                        this.history.pop();
                    }
                    localStorage.setItem('summaryHistory', JSON.stringify(this.history));
                },
                applyHistory(item) {
                    this.activeTab = item.type;
                    if (item.type === 'text') {
                        this.inputText = item.input;
                        this.inputUrl = '';
                    } else {
                        this.inputText = '';
                        this.inputUrl = item.input;
                    }
                    this.resultText = item.output;
                    this.summaryFormat = item.settings.format;
                    this.summaryLength = item.settings.length;
                    this.historyModalInstance.hide();
                },
                deleteHistoryItem(id) {
                    this.history = this.history.filter(item => item.id !== id);
                    localStorage.setItem('summaryHistory', JSON.stringify(this.history));
                },
                clearAllHistory() {
                    if (confirm('本当にすべての履歴を削除しますか？')) {
                        this.history = [];
                        localStorage.removeItem('summaryHistory');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>